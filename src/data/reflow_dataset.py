"""
Reflow Dataset Loading

This module handles loading synthetic (z0, z1) pairs generated by a Teacher model.
"""

import os
import glob
import torch
from torch.utils.data import Dataset, DataLoader
from tqdm import tqdm

class ReflowDataset(Dataset):
    def __init__(self, data_dir: str):
        """
        Loads all .pt files from the data_dir.
        Expects files to contain dict: {'z0': Tensor(B,C,H,W), 'z1': Tensor(B,C,H,W)}
        """
        super().__init__()
        self.data_dir = data_dir
        # Find all .pt files
        self.files = sorted(glob.glob(os.path.join(data_dir, "*.pt")))
        
        if len(self.files) == 0:
            raise ValueError(f"No .pt files found in {data_dir}. Did you run generate_reflow_dataset.py?")
            
        print(f"Loading Reflow dataset from {data_dir}...")
        self.data = []
        
        # Load all batches into memory
        # Note: For 50k images @ 64x64, this is ~2.5GB RAM. 
        # If scaling to ImageNet, you would implement lazy loading here.
        for f_path in tqdm(self.files, desc="Loading Reflow Batches"):
            try:
                batch = torch.load(f_path, map_location='cpu')
                z0s = batch['z0']
                z1s = batch['z1']
                
                # Verify shapes
                if z0s.shape[0] != z1s.shape[0]:
                    print(f"Warning: Sketchy batch in {f_path}, skipping.")
                    continue
                    
                for i in range(z0s.shape[0]):
                    self.data.append((z0s[i], z1s[i]))
            except Exception as e:
                print(f"Error loading {f_path}: {e}")
                
        print(f"Reflow Dataset: Loaded {len(self.data)} pairs.")

    def __len__(self):
        return len(self.data)

    def __getitem__(self, idx):
        z0, z1 = self.data[idx]
        # Return as dictionary to trigger the special logic in train.py
        return {
            'x_0': z0,  # Input Noise
            'x_1': z1   # Target Image
        }

def create_reflow_dataloader(config, split='train'):
    """
    Creates a DataLoader for Reflow. 
    Reflow is typically only used for training the Student.
    """
    if split != 'train':
        return None
        
    data_config = config['data']
    training_config = config['training']
    
    dataset = ReflowDataset(data_dir=data_config['root'])
    
    return DataLoader(
        dataset,
        batch_size=training_config['batch_size'],
        # Shuffle is crucial for Reflow to break correlations between batches
        shuffle=True, 
        num_workers=data_config.get('num_workers', 4),
        pin_memory=data_config.get('pin_memory', True),
        drop_last=True
    )